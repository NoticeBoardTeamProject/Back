with:
  host: ${{ secrets.SSH_HOST }}
  port: ${{ secrets.SSH_PORT }}
  username: ${{ secrets.SSH_USER }}
  key: ${{ secrets.VM_SSH_KEY }}
  script: |
    set -euxo pipefail
    APP_DIR="${{ secrets.APP_DIR }}"
    REPO_URL="https://github.com/${{ github.repository }}.git"
    BRANCH="main"

    if [[ ! -d "$APP_DIR/.git" ]]; then
      sudo rm -rf "$APP_DIR"
      git clone --depth=1 --branch "$BRANCH" "$REPO_URL" "$APP_DIR"
    else
      cd "$APP_DIR"
      git fetch --depth=1 origin "$BRANCH"
      git reset --hard "origin/$BRANCH"
    fi
    cd "$APP_DIR"

    printf "%s" "${{ secrets.APP_ENV }}" > .env
    chmod 600 .env

    docker-compose down || true
    docker-compose up -d --build
    docker-compose ps
